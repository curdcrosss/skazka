Сказка о настройке волшебного королевства сетей
В далеком цифровом королевстве жили-были разные устройства - гордые серверы, трудолюбивые маршрутизаторы и скромные рабочие станции. И вот однажды мудрый системный администратор решил объединить их всех в единую сеть, чтобы они могли общаться между собой и служить на благо королевства.

Глава 1: Наречение имен
Прежде всего, администратор решил дать каждому устройству свое особенное имя, чтобы можно было легко отличать их друг от друга. Он подошел к каждому устройству и произнес волшебные слова:\
hostnamectl set-hostname «имя_машины»; exec bash
Так каждое устройство получило свое полное доменное имя, став полноправным гражданином сетевого королевства. Серверы гордо носили имена HQ-SRV и BR-SRV, маршрутизаторы - HQ-RTR и BR-RTR, а рабочие станции скромно назывались HQ-CLI и BR-DC.
Глава 2: Раздача волшебных адресов
Теперь нужно было обеспечить каждому устройству свой уникальный адрес в королевстве. Для устройств с графическим интерфейсом это было просто - достаточно было щелкнуть правой кнопкой по значку сети, выбрать настройки IPv4 и аккуратно вписать нужные цифры, не забыв сохранить изменения.
А вот для устройств без графического интерфейса пришлось использовать волшебный инструмент nmtui:
Администратор тщательно распределил адреса между всеми жителями королевства, записав их в священный свиток:
                 isp          
ens34 (bf)      ens35 (c9)      
172.16.4.1/28   172.16.5.1/28   
172.16.4.2/28   172.16.5.2/28   
ens34 (ba)      ens34 (54)      
hq-rtr         br-rtr          
ens35 (c4)      ens35 (5e)      
172.16.0.1/26   172.16.6.1/27   
ens33 (d6)      ens34 (af)      ens33 (b2)      (Он винда)
172.16.0.2/26   172.16.0.3/28   172.16.6.2/27   172.16.6.3/27
hq-srv          hq-cli          br-srv          br-DC

Глава 3: Создание верных слуг
Чтобы управлять королевством, администратору нужны были верные помощники. Он создал специального пользователя sshuser, который мог бы выполнять любые команды без лишних вопросов:
useradd -m -u 1010 sshuser
passwd sshuser
Затем он открыл священный свиток sudoers и добавил туда магическую строку, дающую sshuser неограниченные права:
nano /etc/sudoers
Добавил:
sshuser ALL=(ALL:ALL)NOPASSWD:ALL
Сохранил изменения священной комбинацией клавиш: Ctrl+X, Y, Enter. Теперь у него был верный слуга, готовый выполнять любые поручения.
Глава 4: Защитные заклинания
Королевству нужна была защита от злых духов и хакеров. Администратор создал специальное предупреждение для всех, кто попытается войти без разрешения:
nano /etc/mybanner
Написал строгое предупреждение:
Authorized access only
Затем настроил защитные механизмы SSH, изменив конфигурационный файл:
nano /etc/openssh/sshd_config
Установил:
#port 22, раскоменчиваем и пишем port 2024
Banner /etc/mybanner
MaxAuthTries 2
ДОБАВИТЬ строчку - AllowUsers sshuser
После этого перезапустил службу SSH, чтобы изменения вступили в силу:
systemctl restart sshd.service
Теперь королевство было под надежной защитой.

Глава 5: Автоматическая раздача адресов
Чтобы жителям королевства не приходилось вручную запоминать свои адреса, администратор настроил DHCP-сервер на HQ-RTR. Сначала он указал, какой интерфейс будет раздавать адреса:
nano /etc/sysconfig/dhcpd
Добавил строку:
DHCPARGS=ens35
Затем создал конфигурационный файл, взяв за основу пример:
cp /etc/dhcp/dhcpd.conf{.example,}
nano /etc/dhcp/dhcpd.conf
Прописал основные параметры:
Доменное имя королевства "au-team.irpo"
Адреса DNS-серверов
option domain-name-servers 172.16.0.2;
Время аренды адресов
default-lease-time 6000;
max-lease-time 72000;

Диапазон раздаваемых адресов
authoritative;
subnet 172.16.0.0 netmask 255.255.255.192 {
range 172.16.0.3 172.16.0.8;
option routers 172.16.0.1;
}

После этого включил и запустил службу DHCP:
systemctl enable --now dhcpd
Теперь все новые жители королевства автоматически получали свои адреса.
Сказка о настройке волшебного королевства сетей (Продолжение)
Глава 6: Тайный тоннель между замками
Когда основные дороги королевства были проложены, администратор задумался о создании секретного прохода между главным замком HQ и удалённой крепостью BR. Но для этого сначала нужно было получить разрешение от Хранителя Врат — сервера ISP.
Администратор подошёл к ISP и произнёс священные слова:
nano /etc/net/sysctl.conf
Найдя строку net.ipv4.ip_forward, он изменил её значение на 1, словно поворачивая ключ в скрипучем замке:
net.ipv4.ip_forward = 1
Теперь пакеты могли свободно проходить через ISP. Вдохновлённый, администратор взял волшебный инструмент nmtui и начал настраивать GRE-тоннель между HQ-RTR и BR-RTR. Это было подобно прокладыванию подземного хода — невидимого для посторонних глаз, но надёжно соединяющего два удалённых замка.

Глава 7: Живые дороги OSPF
Обычные дороги королевства были статичны — если где-то случался обвал, посланники могли заблудиться. Администратор решил оживить дороги с помощью магии динамической маршрутизации OSPF.
На HQ-RTR он открыл древний свиток:
nano /etc/frr/daemons
И сменил строку ospfd=no на ospfd=yes, пробуждая древний дух маршрутизации. Затем произнёс заклинание активации:
systemctl enable --now frr
Войдя в священный интерфейс vtysh, администратор начал настраивать маршруты:
conf t
router ospf
passive-interface default
network 192.168.0.0/24 area 0
network 172.16.0.0/26 area 0
exit
interface tun1
no ip ospf network broadcast
no ip ospf passive
exit
do write memory
exit
Не забыл он и про настройку TTL для тоннеля:
nmcli connection edit tun1
set ip-tunnel.ttl 64
save
quit
После перезапуска FRR дороги ожили и стали сами находить обходные пути в случае преград. То же самое он проделал и на BR-RTR, и с тех пор посланники между замками никогда не терялись.

Глава 8: Великая книга имён
В королевстве было много жителей, и запомнить все имена становилось трудно. Администратор решил создать Великую Книгу Имён (DNS) на HQ-SRV.
Он начал с изменения основных настроек:
nano /etc/bind/options.conf
Затем создал зоны, скопировав священные образцы:
cd /etc/bind/zone
cp localdomain au.db
cp 127.in-addr.arpa 0.db
Изменив владельцев файлов, чтобы только избранные могли вносить изменения:
chown root:named {au,0}.db
После настройки зонных файлов он перезапустил службу:
systemctl restart bind
Теперь, произнеся заклинание:
host hq-rtr.au-team.irpo
можно было мгновенно узнать адрес любого жителя королевства. "Благослови тебя Омниссия!" — прошептал администратор, любуясь своей работой.
Глава 9: Создание центрального управления
Пришло время объединить всех жителей под единым управлением. Администратор начал настройку Samba AD-DC на HQ-SRV, но сначала временно отключил все интерфейсы через nmtui, чтобы никто не помешал священному ритуалу.
Он очистил старые конфигурации:
rm -f /etc/samba/smb.conf
rm -rf /var/lib/samba
rm -rf /var/cache/samba
Создал новые каталоги и начал процесс провижининга:
mkdir -p /var/lib/samba/sysvol
samba-tool domain provision
После настройки включил службы:
systemctl enable --now samba
systemctl enable --now bind
Когда bind отказался запускаться, администратор не растерялся. Он заглянул в конфигурационный файл, внёс необходимые изменения и перезапустил службу:
nano /etc/bind/named.conf
systemctl restart bind
Проверив статус службы, он убедился, что всё работает как надо. Затем настроил аутентификацию Kerberos:
nano /etc/krb5.conf
samba-tool domain info 127.0.0.1
kinit administrator@au-team.irpo
Глава 10: Первые подданные королевства
Пришло время создать первых пользователей. Администратор открыл волшебный инструмент admc и создал пять верных подданных:
user1.hq
user2.hq
user3.hq
user4.hq
user5.hq
Каждый получил свой уникальный пароль и права в королевстве
